const fs = require('fs');
const constants = require('./constants.js');

// Some constants for this file.
const serviceName = 'ProjectExperienceService';
const apiName = 'ProjectExperience';

// File Names
const jsonSourceFileName = `Consultant-Profile/docs/${serviceName}.openapi3.json`;
const jsonTargetFileName = `Consultant-Profile/docs/${apiName}.json`;
const xmlSourceFileName = `Consultant-Profile/docs/${serviceName}.xml`;
const xmltargetFileName = `Consultant-Profile/docs/${apiName}.edmx`;

// Read file generated by CAP.
let openAPISpec = JSON.parse(fs.readFileSync(jsonSourceFileName,'utf-8'));

// Add missing info required for API hub.
modifyForAPIHub();

// Remove all paths except the batch
deletePaths();

// Set 4xx specific error response
add4xxComponents();

// Set 2xx specific response
add2xxComponents();

// Remove generic 4XX message and add specefic messages.
deleteGenericAndAddSpecific4XXResponse();

// Adding specific 2XX messages.
deleteGenericAndAddSpecific2XXResponse();

// Modify the example of the batch call
modifyBatchExample();

// Setting required and nullable attributes
modifyNullableAndRequired();

// Adds Content-Type header which is required for our API
addContentTypeHeader();

// Modify batch request description
modifyBatchDescription();

// add description of content type header
addContentTypeHeaderDescription()

// Convert json to string to write back in file.
let stringData = JSON.stringify(openAPISpec, null, 2);

// Write modified data back to json file
fs.writeFileSync(jsonSourceFileName, stringData);
// remove .openapi3 from generated file
fs.renameSync(jsonSourceFileName, jsonTargetFileName);
// Convert .xml to .edmx file
fs.renameSync(xmlSourceFileName,xmltargetFileName);

function modifyForAPIHub(){
    openAPISpec['x-sap-shortText'] = 'Manage the project experience information of your workforce.';
    openAPISpec['x-sap-api-type']= 'ODATAV4';
    openAPISpec.info.version = '1.0';

    //set the sandox and production server details
    openAPISpec.servers = constants.servers;

    //Set security schemes inside component
    openAPISpec.components['securitySchemes'] = constants.securitySchemes;
}

function add4xxComponents(){
    Object.keys(constants.error_4xx).forEach((errorResponse) => {
        openAPISpec.components.responses[errorResponse] = constants.error_4xx[errorResponse];
    })
}

function add2xxComponents(){
    Object.keys(constants.success_2xx).forEach((successResponse) => {
        openAPISpec.components.responses[successResponse] = constants.success_2xx[successResponse];
    })
}

function deleteGenericAndAddSpecific4XXResponse(){
    Object.keys(constants.responseStructure).forEach((path) => {
        Object.keys(constants.responseStructure[path]).forEach((httpMethod)=>{
            delete openAPISpec.paths[path][httpMethod].responses['4XX'];
            constants.responseStructure[path][httpMethod].forEach((errorCode)=>{
                openAPISpec.paths[path][httpMethod].responses[errorCode] = constants.errorResponse[errorCode];
            })
        })
    })
}

function deleteGenericAndAddSpecific2XXResponse(){
    Object.keys(constants.responseStructure).forEach((path) => {
        Object.keys(constants.responseStructure[path]).forEach((httpMethod)=>{
            openAPISpec.paths[path][httpMethod].responses['201'] = constants.successResponse['201'];
            openAPISpec.paths[path][httpMethod].responses['204'] = constants.successResponse['204'];
        })
    })
}

function deletePaths(){
    Object.keys(openAPISpec.paths).forEach((path) => {
        if(path !== "/$batch") {
            delete openAPISpec.paths[path];
        };
    });
    delete openAPISpec.tags;
};

function modifyBatchExample(){
    openAPISpec.paths["/$batch"].post.requestBody.content["multipart/mixed;boundary=request-separator"].example = '--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$skip=0&$top=2 HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$orderby=changedAt HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$orderby=workforcePersonExternalID HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$filter=workforcePersonExternalID%20eq%20\'JaneDoe\' HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$filter=firstName%20eq%20\'John\' HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$filter=lastName%20eq%20\'Doe\' HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment,_skillAssignments,_externalWorkExperience($expand=_skillAssignments) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_skillAssignments HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience($expand=_skillAssignments) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment,_skillAssignments HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment,_externalWorkExperience HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_skillAssignments,_externalWorkExperience HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment,_externalWorkExperience($expand=_skillAssignments) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_skillAssignments,_externalWorkExperience($expand=_skillAssignments) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment($filter=workAssignmentID%20eq%20\'Richard.Roe\') HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment($filter=resourceID%20eq%20001a3ed7-527c-8eb3-f00a-d44e95125649) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_primaryWorkAssignment($filter=costCenterID%20eq%20\'CC07\') HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_skillAssignments($filter=profileID%20eq%200013e59c-e066-329a-58d4-f5493f33c5fa) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_skillAssignments($filter=skillID%20eq%2054377fe5-0d47-42e6-ac87-95dabdedf46c) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience($filter=profileID%20eq%200013e59c-e066-329a-58d4-f5493f33c5fa) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience($expand=_skillAssignments($filter=externalWorkExperienceID%20eq%20e2225ac9-80cb-485f-a3e3-1ccaf8a8dd13)) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience($expand=_skillAssignments($filter=profileID%20eq%200013e59c-e066-329a-58d4-f5493f33c5fa)) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET Profiles?$expand=_externalWorkExperience($expand=_skillAssignments($filter=skillID%20eq%208ddaa39f-1ec4-485b-b958-1a94ad85d564)) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET PrimaryWorkAssignment HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET SkillAssignments HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPOST SkillAssignments HTTP/1.1\nContent-Type: application/json\n\n{\n"ID":"277ee374-2b93-45a1-8a20-517d92e3f976",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPATCH SkillAssignments(277ee374-2b93-45a1-8a20-517d92e3f976) HTTP/1.1\nContent-Type: application/json\n\n{\n"skillID": "8ddaa39f-1ec4-485b-b958-1a94ad85d564",\n"proficiencyLevelID": "e27c7b52-0560-4eec-9f1d-9b5faf31e509"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPUT SkillAssignments(277ee374-2b93-45a1-8a20-517d92e3f976) HTTP/1.1\nContent-Type: application/json\n\n{\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nDELETE SkillAssignments(277ee374-2b93-45a1-8a20-517d92e3f976) HTTP/1.1\n\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET ExternalWorkExperience HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPOST ExternalWorkExperience HTTP/1.1\nContent-Type: application/json\n\n{\n"ID":"e77ee293-3fcd-49e8-852f-782de83d028b",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"company": "SampleCompany",\n"project": "SampleProject",\n"role": "SampleRole",\n"startDate": "1970-01-01",\n"endDate": "1971-01-01"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPATCH ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\nContent-Type: application/json\n\n{\n"company": "UpdateSampleCompany",\n"project": "UpdateSampleProject",\n"role": "UpdateSampleRole"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPUT ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\nContent-Type: application/json\n\n{\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"company": "SampleCompany",\n"project": "SampleProject",\n"role": "SampleRole",\n"startDate": "1970-01-01",\n"endDate": "1971-01-01"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nDELETE ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET ExternalWorkExperience?$expand=_skillAssignments HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPOST ExternalWorkExperience HTTP/1.1\nContent-Type: application/json\n\n{\n"ID":"e77ee293-3fcd-49e8-852f-782de83d028b",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"company": "SampleCompany",\n"project": "SampleProject",\n"role": "SampleRole",\n"startDate": "1970-01-01",\n"endDate": "1971-01-01",\n"_skillAssignments":\n[{\n"ID":"02be98a7-af4e-41d0-9eab-78ac3edd3fd4",\n"externalWorkExperienceID":"e77ee293-3fcd-49e8-852f-782de83d028b",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}]\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPATCH ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\nContent-Type: application/json\n\n{\n"company": "UpdateSampleCompany",\n"project": "UpdateSampleProject",\n"role": "UpdateSampleRole"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPUT ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\nContent-Type: application/json\n\n{\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"company": "SampleCompany",\n"project": "SampleProject",\n"role": "SampleRole",\n"startDate": "1970-01-01",\n"endDate": "1971-01-01",\n"_skillAssignments":\n[{\n"ID":"02be98a7-af4e-41d0-9eab-78ac3edd3fd4",\n"externalWorkExperienceID":"e77ee293-3fcd-49e8-852f-782de83d028b",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}]\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nDELETE ExternalWorkExperience(e77ee293-3fcd-49e8-852f-782de83d028b) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET ExternalWorkExperienceSkillAssignments HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPOST ExternalWorkExperienceSkillAssignments HTTP/1.1\nContent-Type: application/json\n\n{\n"ID":"02be98a7-af4e-41d0-9eab-78ac3edd3fd4",\n"externalWorkExperienceID":"e2225ac9-80cb-485f-a3e3-1ccaf8a8dd13",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPATCH ExternalWorkExperienceSkillAssignments(02be98a7-af4e-41d0-9eab-78ac3edd3fd4) HTTP/1.1\nContent-Type: application/json\n\n{\n"skillID": "79993cb1-f928-40ed-96aa-5d33c9d4c4a0",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPUT ExternalWorkExperienceSkillAssignments(02be98a7-af4e-41d0-9eab-78ac3edd3fd4) HTTP/1.1\nContent-Type: application/json\n\n{\n"externalWorkExperienceID":"e2225ac9-80cb-485f-a3e3-1ccaf8a8dd13",\n"profileID":"0013e59c-e066-329a-58d4-f5493f33c5fa",\n"skillID": "6ac12be8-d656-465d-8343-241e2e98d1f7",\n"proficiencyLevelID": "7d4c44a1-b262-4c51-b0ca-de845e96e643"\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nDELETE ExternalWorkExperienceSkillAssignments(02be98a7-af4e-41d0-9eab-78ac3edd3fd4) HTTP/1.1\n\n\n--request-separator--'
};

function modifyNullableAndRequired(){
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-create"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-create"].properties["skillID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-create"].properties["proficiencyLevelID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-create"].required = ["profileID", "skillID", "proficiencyLevelID"];
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-update"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-update"].properties["skillID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.SkillAssignments-update"].properties["proficiencyLevelID"].nullable = false;

    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["company"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["project"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["role"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["startDate"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].properties["endDate"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-create"].required = ["profileID", "company", "project", "role", "startDate", "endDate"];
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["company"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["project"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["role"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["startDate"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperience-update"].properties["endDate"].nullable = false;

    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-create"].properties["externalWorkExperienceID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-create"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-create"].properties["skillID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-create"].properties["proficiencyLevelID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-create"].required = ["externalWorkExperienceID", "profileID", "skillID", "proficiencyLevelID"];
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-update"].properties["externalWorkExperienceID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-update"].properties["profileID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-update"].properties["skillID"].nullable = false;
    openAPISpec.components.schemas["ProjectExperienceService.ExternalWorkExperienceSkillAssignments-update"].properties["proficiencyLevelID"].nullable = false;
};

function addContentTypeHeader(){
    openAPISpec.paths["/$batch"].post["parameters"] = constants.contentTypeHeader;
}


function modifyBatchDescription(){
    openAPISpec.paths["/$batch"].post["description"] = "Group multiple requests into a single request payload, see [Batch Requests](http://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_BatchRequests).";
}

function addContentTypeHeaderDescription() {
    openAPISpec.paths["/$batch"].post.parameters[0].description = "Indicates the media type of the resource."
}


const fs = require('fs');
const constants = require('./constants-WorkforceAvailability.js');

// Some constants for this file.
const serviceName = 'WorkforceAvailabilityService';
const apiName = 'WorkforceAvailability';

// File Names
const jsonSourceFileName = `Consultant-Profile/docs/${serviceName}.openapi3.json`;
const jsonTargetFileName = `Consultant-Profile/docs/${apiName}.json`;
const xmlSourceFileName = `Consultant-Profile/docs/${serviceName}.xml`;
const xmltargetFileName = `Consultant-Profile/docs/${apiName}.edmx`;

// Read file generated by CAP.
let openAPISpec = JSON.parse(fs.readFileSync(jsonSourceFileName,'utf-8'));

// Add missing info required for API hub.
modifyForAPIHub();

// Remove all paths except the batch
deletePaths();

// Set 4xx specific error response
add4xxComponents();

// Set 2xx specific response
add2xxComponents();

// Remove generic 4XX message and add specefic messages.
deleteGenericAndAddSpecific4XXResponse();

// Adding specific 2XX messages.
deleteGenericAndAddSpecific2XXResponse();

// Modify the example of the batch call
modifyBatchExample();

// Setting required and nullable attributes
modifyNullableAndRequired();

// Adds Content-Type header which is required for our API
addContentTypeHeader();

// Modify batch request description
modifyBatchDescription();

//delete schemas which are not needed
deleteUnnecessarySchemas();

//rename typed entities
renameSchemaName()

//add schema descriptions
addSchemaDescriptions()

// add description of content type header
addContentTypeHeaderDescription()

// Convert json to string to write back in file.
let stringData = JSON.stringify(openAPISpec, null, 2);

// Write modified data back to json file
fs.writeFileSync(jsonSourceFileName, stringData);
// remove .openapi3 from generated file
fs.renameSync(jsonSourceFileName, jsonTargetFileName);
// Convert .xml to .edmx file
fs.renameSync(xmlSourceFileName,xmltargetFileName);

function modifyForAPIHub(){
    openAPISpec['x-sap-shortText'] = 'Upload the availability of your workforce.';
    openAPISpec['x-sap-api-type']= 'ODATAV4';
    openAPISpec.info.version = '1.0';

    //set the sandox and production server details
    openAPISpec.servers = constants.servers;

    //Set security schemes inside component
    openAPISpec.components['securitySchemes'] = constants.securitySchemes;
}

function add4xxComponents(){
    Object.keys(constants.error_4xx).forEach((errorResponse) => {
        openAPISpec.components.responses[errorResponse] = constants.error_4xx[errorResponse];
    })
}

function add2xxComponents(){
    Object.keys(constants.success_2xx).forEach((successResponse) => {
        openAPISpec.components.responses[successResponse] = constants.success_2xx[successResponse];
    })
}

function deleteGenericAndAddSpecific4XXResponse(){
    Object.keys(constants.responseStructure).forEach((path) => {
        Object.keys(constants.responseStructure[path]).forEach((httpMethod)=>{
            delete openAPISpec.paths[path][httpMethod].responses['4XX'];
            constants.responseStructure[path][httpMethod].forEach((errorCode)=>{
                openAPISpec.paths[path][httpMethod].responses[errorCode] = constants.errorResponse[errorCode];
            })
        })
    })
}

function deleteGenericAndAddSpecific2XXResponse(){
    Object.keys(constants.responseStructure).forEach((path) => {
        Object.keys(constants.responseStructure[path]).forEach((httpMethod)=>{
            openAPISpec.paths[path][httpMethod].responses['201'] = constants.successResponse['201'];
            openAPISpec.paths[path][httpMethod].responses['204'] = constants.successResponse['204'];
        })
    })
}

function deletePaths(){
    Object.keys(openAPISpec.paths).forEach((path) => {
        if(path !== "/$batch") {
            delete openAPISpec.paths[path];
        };
    });
    delete openAPISpec.tags;
};

function modifyBatchExample(){
    openAPISpec.paths["/$batch"].post.requestBody.content["multipart/mixed;boundary=request-separator"].example = '--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability(workAssignmentID=\'Jane.Doe\',availabilityDate=2017-01-01) HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability?$skip=0&$top=2 HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability?$orderby=workAssignmentID HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability?$filter=workAssignmentID%20eq%20\'Jane.Doe\' HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability?$filter=availabilityDate%20eq%202017-01-01 HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nGET WorkforceAvailability?$filter=workforcePerson_ID%20eq%200013e59c-e066-329a-58d4-f5493f33c5fa HTTP/1.1\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPUT WorkforceAvailability(workAssignmentID=\'Jane.Doe\',availabilityDate=2017-01-01) HTTP/1.1\nContent-Type: application/json\n\n{\n"id":"52a10ff3-e310-430d-8d00-07b582828ac7",\n"workforcePerson_ID": "0013e59c-e066-329a-58d4-f5493f33c5fa",\n"normalWorkingTime": "08:00",\n"availabilitySupplements": [{\n"intervalStart": "09:00:00",\n"intervalEnd": "11:00:00",\n"contribution": "02:00"\n},\n{\n"intervalStart": "15:00:00",\n"intervalEnd": "17:00:00",\n"contribution": "02:00"\n}],\n"availabilityIntervals": [{\n"intervalStart": "11:00:00",\n"intervalEnd": "15:00:00",\n"contribution": "04:00"\n}]\n}\n\n\n--request-separator\nContent-Type: application/http\nContent-Transfer-Encoding:binary\n\nPATCH WorkforceAvailability(workAssignmentID=\'Jane.Doe\',availabilityDate=2017-01-01) HTTP/1.1\nContent-Type: application/json\n\n{\n"availabilitySupplements": [{\n"intervalStart": "09:00:00",\n"intervalEnd": "10:00:00",\n"contribution": "01:00"\n},\n{\n"intervalStart": "15:00:00",\n"intervalEnd": "17:00:00",\n"contribution": "02:00"\n}],\n"availabilityIntervals": [{\n"intervalStart": "10:00:00",\n"intervalEnd": "15:00:00",\n"contribution": "05:00"\n}]\n}\n\n\n--request-separator--'
};

function modifyNullableAndRequired(){
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].properties["workforcePerson_ID"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].properties["normalWorkingTime"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].required = ["workAssignmentID", "workforcePerson_ID", "availabilityDate", "normalWorkingTime", "availabilityIntervals", "availabilitySupplements"];
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-create"].properties["workforcePerson_ID"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-create"].properties["normalWorkingTime"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalStart"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalEnd"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["contribution"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].required = ["intervalStart", "intervalEnd", "contribution"];
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalStart"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalEnd"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["contribution"].nullable = false;
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].required = ["intervalStart", "intervalEnd", "contribution"];
};

function addContentTypeHeader(){
    openAPISpec.paths["/$batch"].post["parameters"] = constants.contentTypeHeader;
}


function modifyBatchDescription(){
    openAPISpec.paths["/$batch"].post["description"] = "Group multiple requests into a single request payload, see [Batch Requests](http://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_BatchRequests).";
}

function deleteUnnecessarySchemas(){
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes_texts"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes_texts-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.HolidayCodes_texts-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes_texts"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes_texts-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.ShiftCodes_texts-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval-create"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval-update"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].properties["shiftCode"];
    delete openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].properties["holidayCode"];
}

function renameSchemaName() {
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].title = "WorkforceAvailabilitySupplement";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].title = "WorkforceAvailabilityTimeInterval";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-create"].properties["availabilityIntervals"].items["$ref"] = "#/components/schemas/WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-create"].properties["availabilitySupplements"].items["$ref"] = "#/components/schemas/WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-update"].properties["availabilityIntervals"].items["$ref"] = "#/components/schemas/WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-update"].properties["availabilitySupplements"].items["$ref"] = "#/components/schemas/WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement";
}

function addSchemaDescriptions() {
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability"].description = "The availability of a workforce person.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-create"].description = "Creates an availability record for a single worker.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.WorkforceAvailability-update"].description = "Updates the availability record for a single worker.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].description = "The absence during regular working hours.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalStart"].description = "Start of the time interval; a time of day in format hh:mm:ss without time zone.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalStart"].example = "09:00:00";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalEnd"].description = "End of the time interval; a time of day in format hh:mm:ss without time zone.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["intervalEnd"].example = "13:00:00";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["contribution"].description = "The number of hours when a workforce person is not available during regular working hours.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilitySupplement"].properties["contribution"].example = "04:00";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].description = "The availability during regular working hours.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalStart"].description = "Start of the time interval; a time of day in format hh:mm:ss without time zone.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalStart"].example = "13:00:00";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalEnd"].description = "End of the time interval; a time of day in format hh:mm:ss without time zone.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["intervalEnd"].example = "17:00:00";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["contribution"].description = "The number of hours when a workforce person is available during regular working hours.";
    openAPISpec.components.schemas["WorkforceAvailabilityService.com_sap_resourceManagement_employee_workforceAvailability_WorkforceAvailabilityTimeInterval"].properties["contribution"].example = "04:00";
}

function addContentTypeHeaderDescription() {
    openAPISpec.paths["/$batch"].post.parameters[0].description = "Indicates the media type of the resource."
}
